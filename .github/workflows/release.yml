name: Release

# Triggered when a version tag is pushed (via standard-version: npm run release)
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # =============================================================================
  # Windows Build - electron-builder auto-publishes to GitHub Releases
  # =============================================================================
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Download FFmpeg for Windows
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path resources/ffmpeg
          Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile ffmpeg.zip
          Expand-Archive -Path ffmpeg.zip -DestinationPath ffmpeg-temp -Force
          $ffmpegDir = Get-ChildItem -Path ffmpeg-temp -Directory | Select-Object -First 1
          Copy-Item "$($ffmpegDir.FullName)/bin/ffmpeg.exe" -Destination resources/ffmpeg/
          Copy-Item "$($ffmpegDir.FullName)/bin/ffprobe.exe" -Destination resources/ffmpeg/
          Remove-Item -Recurse -Force ffmpeg-temp, ffmpeg.zip

      - name: Install dependencies
        run: npm ci

      - name: Build and publish Electron app
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: npm run build

      - name: Verify auto-update files exist
        shell: pwsh
        run: |
          $yml = "dist/electron/Packaged/latest.yml"
          if (-not (Test-Path $yml)) {
            Write-Error "FATAL: $yml not found! Auto-update will be broken for Windows users."
            exit 1
          }
          $content = Get-Content $yml -Raw
          if ($content -notmatch "version:" -or $content -notmatch "sha512:") {
            Write-Error "FATAL: $yml is malformed! Missing version or sha512."
            exit 1
          }
          Write-Host "latest.yml OK:"
          Write-Host $content

  # =============================================================================
  # macOS Build - sign, notarize, then upload to release
  # =============================================================================
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Download FFmpeg for macOS
        run: |
          mkdir -p resources/ffmpeg/darwin
          curl -L "https://ffmpeg.martin-riedl.de/redirect/latest/macos/arm64/release/ffmpeg.zip" -o ffmpeg-arm64.zip
          curl -L "https://ffmpeg.martin-riedl.de/redirect/latest/macos/amd64/release/ffmpeg.zip" -o ffmpeg-amd64.zip
          unzip -o ffmpeg-arm64.zip -d ffmpeg-arm64
          unzip -o ffmpeg-amd64.zip -d ffmpeg-amd64
          lipo -create -output resources/ffmpeg/darwin/ffmpeg ffmpeg-arm64/ffmpeg ffmpeg-amd64/ffmpeg
          chmod +x resources/ffmpeg/darwin/ffmpeg
          rm -rf ffmpeg-arm64 ffmpeg-amd64 ffmpeg-arm64.zip ffmpeg-amd64.zip

      - name: Install dependencies
        run: npm ci

      - name: Import code signing certificate
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          if [ -z "$CSC_LINK" ]; then
            echo "ERROR: CSC_LINK is empty!"
            exit 1
          fi

          # Decode and import certificate
          echo "$CSC_LINK" | base64 --decode > certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import certificate.p12 -P "$CSC_KEY_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH" login.keychain-db

          echo "Installed certificates:"
          security find-identity -v "$KEYCHAIN_PATH"

          rm certificate.p12

          echo "CSC_KEYCHAIN=$KEYCHAIN_PATH" >> $GITHUB_ENV

          # Write API key for notarization
          API_KEY_DIR="$HOME/private_keys"
          mkdir -p "$API_KEY_DIR"
          echo "$API_KEY_CONTENT" > "$API_KEY_DIR/AuthKey_${API_KEY_ID}.p8"
          echo "APPLE_API_KEY_PATH=$API_KEY_DIR/AuthKey_${API_KEY_ID}.p8" >> $GITHUB_ENV

      - name: Sign FFmpeg binary
        run: |
          echo "=== Signing FFmpeg binary with Developer ID ==="
          # Get the signing identity
          IDENTITY=$(security find-identity -v -p codesigning "$CSC_KEYCHAIN" | grep "Developer ID Application" | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "Using identity: $IDENTITY"

          # Sign ffmpeg with hardened runtime and timestamp
          codesign --sign "$IDENTITY" \
            --keychain "$CSC_KEYCHAIN" \
            --options runtime \
            --timestamp \
            --force \
            resources/ffmpeg/darwin/ffmpeg

          # Verify the signature
          echo "Verifying FFmpeg signature..."
          codesign --verify --deep --strict --verbose=2 resources/ffmpeg/darwin/ffmpeg
          echo "=== FFmpeg signed successfully ==="

      - name: Build Electron app for macOS
        env:
          # GH_TOKEN is needed by electron-builder to resolve GitHub publish provider
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          # -P never: generate latest-mac.yml but don't upload artifacts
          # We upload manually after notarization via action-gh-release
          npx quasar build -m electron -P never

      - name: Verify auto-update files exist
        run: |
          echo "=== Checking latest-mac.yml ==="
          if [ ! -f dist/electron/Packaged/latest-mac.yml ]; then
            echo "FATAL: latest-mac.yml not found! Auto-update will be broken for macOS users."
            echo "This usually means the publish config in quasar.config.js was removed or -P never was not passed."
            exit 1
          fi
          if ! grep -q "version:" dist/electron/Packaged/latest-mac.yml || ! grep -q "sha512:" dist/electron/Packaged/latest-mac.yml; then
            echo "FATAL: latest-mac.yml is malformed! Missing version or sha512."
            exit 1
          fi
          echo "latest-mac.yml OK:"
          cat dist/electron/Packaged/latest-mac.yml
          echo ""
          echo "=== Checking zip files for auto-update ==="
          ZIP_COUNT=$(find dist/electron/Packaged -name "*.zip" | wc -l)
          if [ "$ZIP_COUNT" -lt 2 ]; then
            echo "FATAL: Expected at least 2 zip files (x64 + arm64), found $ZIP_COUNT"
            exit 1
          fi
          echo "Found $ZIP_COUNT zip files - OK"

      - name: Verify code signing
        run: |
          echo "=== Verifying code signing ==="
          APP_PATH=$(find dist/electron/Packaged -name "*.app" -maxdepth 2 | head -1)
          echo "Checking app: $APP_PATH"
          codesign --verify --deep --strict --verbose=2 "$APP_PATH"
          echo ""
          echo "=== Gatekeeper assessment ==="
          spctl --assess --type exec --verbose "$APP_PATH" || true
          echo ""
          echo "=== Signing identity ==="
          codesign -dvv "$APP_PATH" 2>&1 | head -20
          echo "=== Code signing OK ==="

      - name: Notarize macOS app
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        timeout-minutes: 45
        run: |
          NOTARY_ARGS="--key $APPLE_API_KEY_PATH --key-id $API_KEY_ID --issuer $API_ISSUER_ID"

          echo "=== Notarizing macOS DMG files ==="
          for dmg in dist/electron/Packaged/*.dmg; do
            echo "========================================="
            echo "Submitting $dmg for notarization..."
            echo "========================================="

            # Submit and wait (up to 40 min)
            xcrun notarytool submit "$dmg" $NOTARY_ARGS --wait --timeout 40m 2>&1 | tee /tmp/notary-output.txt || true

            # Extract submission ID
            SUB_ID=$(grep -oE '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}' /tmp/notary-output.txt | head -1)
            echo "Submission ID: $SUB_ID"

            # Always fetch the log from Apple (shows exact rejection reason if any)
            if [ -n "$SUB_ID" ]; then
              echo ""
              echo "=== Apple notarization log ==="
              xcrun notarytool log "$SUB_ID" $NOTARY_ARGS /tmp/notary-log.json 2>&1 || true
              cat /tmp/notary-log.json 2>/dev/null || echo "(no log available yet)"
              echo ""
            fi

            # Check if it was accepted
            if grep -q "status: Accepted" /tmp/notary-output.txt; then
              echo "Notarization ACCEPTED for $dmg"
              echo "Stapling notarization ticket..."
              xcrun stapler staple "$dmg"
            elif grep -q "status: Invalid" /tmp/notary-output.txt; then
              echo "ERROR: Notarization REJECTED for $dmg"
              echo "Check the Apple log above for details"
              exit 1
            else
              echo "WARNING: Notarization status unknown (may have timed out)"
              echo "Check submission $SUB_ID manually"
              exit 1
            fi
          done
          echo "=== All DMGs notarized and stapled ==="

      - name: Upload macOS artifacts to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            dist/electron/Packaged/*.dmg
            dist/electron/Packaged/*.dmg.blockmap
            dist/electron/Packaged/*.zip
            dist/electron/Packaged/*.zip.blockmap
            dist/electron/Packaged/latest-mac.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify release has auto-update files
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Verifying GitHub Release assets ==="
          TAG="${{ github.ref_name }}"
          ASSETS=$(gh release view "$TAG" --json assets --jq '.assets[].name')
          echo "Release assets:"
          echo "$ASSETS"
          echo ""
          if ! echo "$ASSETS" | grep -q "latest-mac.yml"; then
            echo "FATAL: latest-mac.yml is missing from GitHub Release $TAG!"
            echo "macOS auto-update will NOT work. Investigate and re-upload."
            exit 1
          fi
          echo "latest-mac.yml present in release - auto-update OK"
