# Fastfile for Suisse Notes iOS
# Documentation: https://docs.fastlane.tools

default_platform(:ios)

platform :ios do
  desc "Load App Store Connect API Key"
  lane :load_api_key do
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_filepath: "~/.appstoreconnect/private_keys/AuthKey_#{ENV['APP_STORE_CONNECT_API_KEY_ID']}.p8",
      in_house: false
    )
  end

  desc "Sync code signing certificates"
  lane :sync_certificates do
    match(
      type: "appstore",
      readonly: is_ci,
      git_url: ENV["MATCH_GIT_URL"],
      app_identifier: "ch.suissenotes.mobile"
    )
  end

  desc "Build release IPA"
  lane :build do
    # Setup CI environment if running on CI
    setup_ci if is_ci

    # Sync certificates
    sync_certificates

    # Set team and signing settings
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "App.xcodeproj",
      team_id: "UTU38DWABG",
      bundle_identifier: "ch.suissenotes.mobile",
      profile_name: "match AppStore ch.suissenotes.mobile",
      code_sign_identity: "Apple Distribution"
    )

    # Increment build number based on TestFlight
    increment_build_number(
      build_number: latest_testflight_build_number + 1,
      xcodeproj: "App.xcodeproj"
    )

    # Build the app
    build_app(
      project: "App.xcodeproj",
      scheme: "App",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "SuisseNotes.ipa"
    )
  end

  desc "Deploy to TestFlight"
  lane :beta do
    # Load API key
    load_api_key

    # Build the app
    build

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      distribute_external: false,
      notify_external_testers: false
    )
  end

  desc "Deploy to TestFlight and notify testers"
  lane :beta_notify do
    # Load API key
    load_api_key

    # Build the app
    build

    # Upload to TestFlight and notify testers
    upload_to_testflight(
      skip_waiting_for_build_processing: false,
      distribute_external: true,
      notify_external_testers: true,
      groups: ["Beta Testers"]
    )
  end

  desc "Deploy to App Store"
  lane :release do
    # Load API key
    load_api_key

    # Build the app
    build

    # Upload to App Store
    upload_to_app_store(
      skip_metadata: true,
      skip_screenshots: true,
      precheck_include_in_app_purchases: false,
      submit_for_review: false,
      automatic_release: false
    )
  end

  desc "Deploy to App Store and submit for review"
  lane :release_submit do
    # Load API key
    load_api_key

    # Build the app
    build

    # Upload to App Store and submit
    upload_to_app_store(
      skip_metadata: false,
      skip_screenshots: false,
      precheck_include_in_app_purchases: false,
      submit_for_review: true,
      automatic_release: true,
      submission_information: {
        add_id_info_uses_idfa: false
      }
    )
  end

  desc "Download screenshots from App Store Connect"
  lane :download_screenshots do
    load_api_key
    download_from_app_store_connect(
      app_identifier: "ch.suissenotes.mobile"
    )
  end

  desc "Register new devices"
  lane :register_device do |options|
    device_name = options[:name]
    device_udid = options[:udid]

    register_devices(
      devices: {
        device_name => device_udid
      }
    )

    # Regenerate provisioning profiles
    match(
      type: "development",
      force_for_new_devices: true,
      app_identifier: "ch.suissenotes.mobile"
    )
  end
end
